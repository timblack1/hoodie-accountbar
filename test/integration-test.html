<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">

    <script src="../../webcomponentsjs/webcomponents-lite.js"></script>
    <link rel="import" href="../../polymer/polymer.html">
    <script src="../../web-component-tester/browser.js"></script>
    <script src="../../test-fixture/test-fixture-mocha.js"></script>
    <link rel="import" href="../../test-fixture/test-fixture.html">

    <link rel="import" href="../hoodie-accountbar.html">

  </head>
  <body>

    <test-fixture id="integration">
      <template>
        <hoodie-accountbar></hoodie-accountbar>
      </template>
    </test-fixture>

    <script>
    'use strict';
      
    // Note:  These are mostly integration tests, since this element integrates Hoodie and Polymer.

    // TODO: Test each mode's effects on authentication, data, UI
    // TODO: Review the outline below to see if it covers all cases we need to test.
    // TODO: Review the tests to see if they match the outline.
    /*
    Construct state in setup(), then click the following button:

    Signed-out state, browser has not signed in
      Sign Up
        Dialog displays
        Dialog contains
          Username
          Password
          Confirm Password
          "Sign Up" button
        Auth function()
    Signed-out state, browser has signed in
      "Sign In" button displays
    Signed-out state
      Sign In
        Dialog displays
        Dialog contains
          Username
          Password
          "Sign In" button
        Auth function()
      Forgot Password
        Dialog displays
        Dialog contains
          Username
          "Email Me A New Password" button
        Password changed
      Clear local data
        Verify local data is gone
    Signed-in state
      Change Username
      Change Password
      Destroy Account
        Verify account is gone
      Sign Out
        "Sign In" button displays
        User not authenticated
        Welcome message doesn't display
    State: Sign in with wrong credentials, or sign up with existing credentials
      Authentication error. Sign in again

    Auth function()
      User authenticated
        Button changes to "Sign Out"
        Welcome message displays username
      User not authenticated (empty or nonexistent username or password)
        Button changes to "Authentication error. Sign in again"
        Welcome message does not display

    */

    // Silence jshint
    var assert = assert;
    var test = test;
    var setup = setup;
    var suite = suite;
    var flush = flush;
    var fixture = fixture;
    var teardown = teardown;

    // Configure defaults
    var username = 'test';
    var password = 'pw';
    var wrong_username = 'test_wrong';
    var wrong_password = 'pw_wrong';
    var hoodie;
    var accountbar;

    // -------- BEGIN Utility functions ---------

    function delete_localstorage_signedin_record(){
      // Remove the record that the user has signed in previously through Hoodie.
      localStorage.removeItem('has_signed_in_through_hoodie');
    }

    function create_localstorage_signedin_record(){
      // Create the record that the user has signed in previously through Hoodie.
      localStorage['has_signed_in_through_hoodie'] = 'true';
    }

    function create_test_user_account(hoodie, done){
//       // Sign out in case previous calls to hoodie.account.destroy() failed.
//       hoodie.account.signOut({ignoreLocalChanges: true})
//       .done(hoodie.account.signUp(username, password))
      return Promise.resolve().then(function(){
        return hoodie.account.signUp(username, password)
        .then(function(){
          return done();
        })
        // If it fails, that probably just means the user account already exists,
        //  which is not a problem for us.
        .fail(function(error){
          console.log(error);
          return done();
        });
      }).catch(console.log.bind(console));
    }

    function destroy_test_user_account(hoodie, flush, done){
      // TODO: This works if the user is signed in.  It doesn't work if the
      //  user account has already been destroyed in CouchDB.  Then it returns
      //  a 401 Unauthorized error:  "Name or password is incorrect."
      return Promise.resolve().then(function(){
        if (typeof hoodie.account.username !== 'undefined'){
          // User is signed in, so destroy account and delete localStorage signed in record
          return hoodie.account.destroy()
          .then(function(){
            console.log('Account was destroyed!');
            console.log('Deleting localstorage record');
            return delete_localstorage_signedin_record();
          })
          .then(function(){
            return flush(done);
          });
        }else{
          // User is not signed in, so attempt to sign in as test user
          return hoodie.account.signIn(username, password)
          // If successful, destroy account and delete localStorage signed in record
          .then(function(){
            return hoodie.account.destroy();
          })
          .then(function(){
            return delete_localstorage_signedin_record();
          })
          // Wait for UI to update
          .then(function(){
            return flush(done);
          })
          // Else wait for UI to update (do the same thing as above)
          .fail(function(){
            return flush(done);
          });
        }        
      }).catch(console.log.bind(console));
    }

    // -------- END Utility functions ---------
    
    suite('Signed-out state, browser has never signed in', function(){

      setup('Before each test, destroy test user account and delete localstorage record', function(done){
        accountbar = fixture('integration');
        hoodie = accountbar.hoodie;
        destroy_test_user_account(hoodie, flush, done);
      });

      teardown('After each test, destroy test user account and delete localstorage record', function(done){
        accountbar = fixture('integration');
        hoodie = accountbar.hoodie;
        destroy_test_user_account(hoodie, flush, done);
      });

      test('should display the "Sign Up" button', function() {
        assert.equal(getComputedStyle(accountbar.$.signup_button).display, 'inline-block');
      });

      test('should display the "Sign In," "Forgot Password," and "Clear local data" menu items', function() {
        assert.equal(getComputedStyle(accountbar.$.signin_button_submenu).display, 'flex');
        assert.equal(getComputedStyle(accountbar.$.forgot_password_button).display, 'flex');
        assert.equal(getComputedStyle(accountbar.$.clear_local_data_button_signup).display, 'flex');
      });

      test('should let you sign up', function(done) {
        /* Test that:
          Dialog displays
          Dialog contains
            Username
            Password
            Confirm Password
            "Sign Up" button
          Auth function()
        */
        
        // Tap button to open dialog
        var button = accountbar.$.signup_button;
        button.fire('tap');
        var dialog = accountbar.$.signup_dialog;
        dialog.addEventListener('iron-overlay-opened', function dialog_opened_handler(event){
          dialog.removeEventListener(event.type, dialog_opened_handler);
        
          // Verify dialog displays & contains correct elements
          // Note:  Query by [label=] since the dialogs can't use IDs when they duplicate elements.
          assert.equal(getComputedStyle(dialog.querySelector('[label=Username]')).display, 'block');
          assert.equal(getComputedStyle(dialog.querySelector('[label=Password]')).display, 'block');
          assert.equal(getComputedStyle(dialog.querySelector('[label="Confirm password"]')).display, 'block');
          assert.equal(getComputedStyle(dialog.querySelector('#signup_dialog_button')).display, 'block');
        
          // Verify that you can sign up
          dialog.querySelector('[label=Username]').value = username;
          dialog.querySelector('[label=Password]').value = password;
          dialog.querySelector('[label="Confirm password"]').value = password;
          // Flush events to permit paper-inputs to register their new values
          flush(function(){
        
            // Sign up
            dialog.querySelector('#signup_dialog_button').fire('tap');
        
            // Verify the username is displayed
            assert.equal(accountbar.$.username_span.textContent, username);
            hoodie.account.on('signup', function signin_handler(){
              flush(function(){
                // Verify the "Sign Out" button is displayed
                assert.equal(getComputedStyle(accountbar.$.signout_button).display, 'inline-block');
                assert.equal(accountbar.$.signout_button.textContent.trim(), 'Sign Out');
                done();
              });
            });
          });
        });

      });

    });

    suite('Signed-out state, browser has signed in before', function(){

      setup('Before each test, create test user account, signout, and set localstorage record that this browser has signed in', function(done){
        accountbar = fixture('integration');
        hoodie = accountbar.hoodie;
        create_test_user_account(hoodie, function(){
          // Signout in case a user is signed in
          hoodie.account.signOut()
          // Wait for UI to update
          .done(flush(function(){
            create_localstorage_signedin_record();
            done();
          }));
        });
      });

      teardown('After each test, destroy test user account and delete localstorage record', function(done){
        accountbar = fixture('integration');
        hoodie = accountbar.hoodie;
        destroy_test_user_account(hoodie, flush, done);
      });

      test('should display the "Sign In" button', function() {
        assert.equal(getComputedStyle(accountbar.$.signin_button).display, 'inline-block');
      });
    
    });

    suite('Signed-out state, browser has or has not signed in', function(){

      setup('Before each test, create test user account and signout', function signout(done){
        accountbar = fixture('integration');
        hoodie = accountbar.hoodie;
        create_test_user_account(hoodie, function(){
          // Signout in case a user is signed in
          hoodie.account.signOut()
          // Wait for UI to update
          // .done(flush(done));
          .done(function(){
            flush(done);
          })
          .fail(function(error){
            console.log('Failed to sign out!');
            console.error(error);
          });
        });
      });

      teardown('After each test, destroy test user account and delete localstorage record', function(done){
        accountbar = fixture('integration');
        hoodie = accountbar.hoodie;
        destroy_test_user_account(hoodie, flush, done);
      });

      test('should let you sign in', function(done) {
        /*
        Test that:
        Dialog displays
        Dialog contains
          Username
          Password
          "Sign In" button
        Auth function()
        */

        // Tap button to open dialog
        var button;
        if (getComputedStyle(accountbar.$.signin_bar).display === 'block'){
          button = accountbar.$.signin_button;
        }else if (getComputedStyle(accountbar.$.signup_bar).display === 'block'){
          button = accountbar.$.signin_button_submenu;
        }
        button.fire('tap');
        var dialog = accountbar.$.signin_dialog;
        dialog.addEventListener('iron-overlay-opened', function dialog_opened_handler(event){
          dialog.removeEventListener(event.type, dialog_opened_handler);
          // Verify dialog displays & contains correct elements
          // Note:  Query by [label=] since the dialogs can't use IDs.
          assert.equal(getComputedStyle(dialog.querySelector('[label=Username]')).display, 'block');
          assert.equal(getComputedStyle(dialog.querySelector('[label=Password]')).display, 'block');
          assert.equal(getComputedStyle(dialog.querySelector('#signin_dialog_button')).display, 'block');
          // Verify that you can sign in
          dialog.querySelector('[label=Username]').value = username;
          dialog.querySelector('[label=Password]').value = password;
          // Flush events to permit paper-inputs to register their new values
          flush(function(){
            // Sign in
            dialog.querySelector('#signin_dialog_button').fire('tap');
            // Verify the username is displayed
            assert.equal(accountbar.$.username_span.textContent, username);
            // Verify the signout button is displayed
            hoodie.account.on('signin', function signin_handler(){
              flush(function(){
                // Verify the "Sign out" button is displayed
                assert.equal(getComputedStyle(accountbar.$.signout_button).display, 'inline-block');
                assert.equal(accountbar.$.signout_button.textContent.trim(), 'Sign Out');
                done();
              });
            });
          });
        });

      });

    });

    suite('Signed-out state', function(){

      setup('Before each test, create test user account and sign out', function(done){
        accountbar = fixture('integration');
        hoodie = accountbar.hoodie;
        create_test_user_account(hoodie, function(){
          // Signout in case a user is signed in
          hoodie.account.signOut()
          // Wait for UI to update
          .done(function(){
            flush(done);
          });
        });
      });

      teardown('After each test, destroy test user account and delete localstorage record', function(done){
        accountbar = fixture('integration');
        hoodie = accountbar.hoodie;
        destroy_test_user_account(hoodie, flush, done);
      });

      /**
       * TODO: I don't know how to get the new password out of my email here to know whether the integration worked.
       *    It would be fine to just test for the 'passwordreset' event, but then we don't know the user's new password,
       *    so this test is disabled for now.  Maybe someday we can write a way to delete the test user from the
       *    database after this test is done. #18
       */
//       test('should allow you to get a new password', function() {
//         /*
//         Forgot Password
//           Dialog displays
//           Dialog contains
//             Username
//             "Email Me A New Password" button
//           Password changed
//         */
        
//         // Tap button to open dialog
//         var button = accountbar.$.forgot_password_button;
//         button.fire('tap');
//         var dialog = accountbar.$.forgot_password_dialog;
//         dialog.addEventListener('iron-overlay-opened', function dialog_opened_handler(event){
//           dialog.removeEventListener(event.type, dialog_opened_handler);
//           // Verify dialog displays & contains correct elements
//           // Note:  Query by [label=] since the dialogs can't use IDs.
//           assert.equal(getComputedStyle(dialog.querySelector('[label=Username]')).display, 'block');
//           assert.equal(getComputedStyle(dialog.querySelector('#forgotpassword_dialog_button')).display, 'block');
//           // Verify that you can sign in
//           dialog.querySelector('[label=Username]').value = username;
//           // Flush events to permit paper-inputs to register their new values
//           flush(function(){
//             // Submit form
//             dialog.querySelector('#forgotpassword_dialog_button').fire('tap');
//             hoodie.account.on('passwordreset', function passwordreset_handler(event){
//               flush(function(){
//                 // TODO: Verify the new password has been emailed
//                 assert.equal(1,0);
//                 done();
//               });
//             });
//           });
//         });
//       });

      test('should allow you to clear local data', function(done) {
        /*
        Clear local data
          Verify local data is gone
        */

        // Tap button to open dialog
        var button = accountbar.$.clear_local_data_button_signin;
        button.fire('tap');
        var dialog = accountbar.$.data_destruction_dialog;
        dialog.addEventListener('iron-overlay-opened', function dialog_opened_handler(event){
          dialog.removeEventListener(event.type, dialog_opened_handler);
          // Verify dialog displays & contains correct elements
          assert.equal(getComputedStyle(dialog.querySelector('#destroy_data_button')).display, 'block');
          // Verify that you can destroy local data
          // Submit form
          dialog.querySelector('#destroy_data_button').fire('tap');
          accountbar.addEventListener('account_destroyed', function data_destroyed_handler(event){
            accountbar.removeEventListener(event.type, data_destroyed_handler);
            // Verify the local data is gone
            var hoodie_config = localStorage.getItem('_hoodie_config');
            assert.includeMembers(['{}', null], [hoodie_config], 'hoodie_config should be an empty object or null');
            done();
          });
        });
      });

    });

    suite('Signed-in state', function(){
      
      setup('Before each test, create test user account and sign in', function(done){
        accountbar = fixture('integration');
        hoodie = accountbar.hoodie;
        create_test_user_account(hoodie, function(){
//           // Signin in case a user is signed out
//           hoodie.account.signIn(username, password)
//           // Wait for UI to update
//           .done(function(){
//             flush(done);
//           })
//           .fail(function(error){
//             console.error(error);
//             hoodie.account.signUp(username, password)
//             .done(function(){
//               console.log('I wasn\'t able to signin, but was able to signup, so we\'re good.');
//               done();
//             })
//             // TODO: start here.  It says "Name or password is incorrect."
//             .fail(console.error);
//           });
          done();
        });
      });

      teardown('After each test, destroy test user account and delete localstorage record', function(done){
        accountbar = fixture('integration');
        hoodie = accountbar.hoodie;
        destroy_test_user_account(hoodie, flush, done);
      });

      test('should allow you to change your username', function(done) {
        /*
        Change Username
        */

        var new_username = 'test_changed';

        // Tap button to open dialog
        var button = accountbar.$.changeusername_button;
        button.fire('tap');
        var dialog = accountbar.$.changeusername_dialog;
        dialog.addEventListener('iron-overlay-opened', function dialog_opened_handler(event){
          dialog.removeEventListener(event.type, dialog_opened_handler);
          // Verify dialog displays & contains correct elements
          assert.equal(getComputedStyle(dialog.querySelector('[label="New Username"]')).display, 'block');
          assert.equal(getComputedStyle(dialog.querySelector('[label="Current Password"]')).display, 'block');
          assert.equal(getComputedStyle(accountbar.$.changeusername_dialog_button).display, 'block');
          // Verify that you can change your username
          dialog.querySelector('[label="New Username"]').value = new_username;
          dialog.querySelector('[label="Current Password"]').value = password;
          // Submit form
          dialog.querySelector('#changeusername_dialog_button').fire('tap');
          hoodie.account.on('changeusername', function(){
            // Verify the username has changed
            assert.equal(hoodie.account.username, new_username);
            done();
          });
        });
      });
    
      test('should allow you to change your password', function(done) {
        /*
        Change Password
        Note:  This test can cause other tests to fail, if this test does not reset
          the password back to its original value.
        */

        var new_password = 'pw_changed';

        // Tap button to open dialog
        var button = accountbar.$.changepassword_button;
        button.fire('tap');
        var dialog = accountbar.$.changepassword_dialog;
        dialog.addEventListener('iron-overlay-opened', function dialog_opened_handler(event){
          dialog.removeEventListener(event.type, dialog_opened_handler);
          // Verify dialog displays & contains correct elements
          assert.equal(getComputedStyle(dialog.querySelector('[label="Current Password"]')).display, 'block');
          assert.equal(getComputedStyle(dialog.querySelector('[label="New Password"]')).display, 'block');
          assert.equal(getComputedStyle(accountbar.$.changepassword_dialog_button).display, 'block');
          // Verify that you can change your password
          dialog.querySelector('[label="Current Password"]').value = password;
          dialog.querySelector('[label="New Password"]').value = new_password;
          // Submit form
          dialog.querySelector('#changepassword_dialog_button').fire('tap');
          hoodie.account.on('changepassword', function(){
            // Verify the password has changed
            debugger;
            hoodie.account.signOut()
            .done(hoodie.account.signIn(username, new_password))
            .done(function(){
              debugger;
              done();
            })
            // Let the test time out if something above failed.
            .fail(function(){
              debugger;
            }).catch(console.log.bind(console));
          });
        });
      });
    
      test('should allow you to destroy your account', function(done) {
        /*
        Destroy Account
        */

        // Tap button to open dialog
        var button = accountbar.$.destroy_account;
        button.fire('tap');
        var dialog = accountbar.$.data_destruction_dialog;
        dialog.addEventListener('iron-overlay-opened', function dialog_opened_handler(event){
          dialog.removeEventListener(event.type, dialog_opened_handler);
          // Verify dialog displays & contains correct elements
          assert.equal(getComputedStyle(dialog.querySelector('#destroy_data_button')).display, 'block');
          // Verify that you can destroy your account
          // Submit form
          dialog.querySelector('#destroy_data_button').fire('tap');
          accountbar.addEventListener('account_destroyed', function signup_user(){
            accountbar.removeEventListener(event.type, signup_user);
            done();
          });
        });
      });
    
      test('should allow you to sign out', function() {
        /*
        Sign Out
          "Sign In" button displays
          User not authenticated
          Welcome message doesn't display
        */

        // Tap button to open dialog
        var button = accountbar.$.signout_button;
        button.fire('tap');
        hoodie.account.on('signout', function(){
          // Verify "Sign In" button displays
          assert.equal(getComputedStyle(accountbar.$.signin_bar).display, 'block');
          // Verify that the signedin_bar (and so its welcome message) doesn't display
          assert.equal(getComputedStyle(accountbar.$.signedin_bar).display, 'none');
        });
      });
    
    });

    suite('State: Sign in with wrong credentials', function(){

      setup('Before each test, create test user account and sign out', function(done){
        accountbar = fixture('integration');
        hoodie = accountbar.hoodie;
        create_test_user_account(hoodie, function(){
          // Signout in case a user is signed in
          hoodie.account.signOut()
          .done(function(){
            done();
          });
        });
      });

      teardown('After each test, destroy test user account and delete localstorage record', function(done){
        accountbar = fixture('integration');
        hoodie = accountbar.hoodie;
        destroy_test_user_account(hoodie, flush, done);
      });

      test('should reopen the dialog, and should display an authentication error (and prompt the user to sign in again)', function(done) {
        /*
        Authentication error. Sign in again
        */

        // Sign in with wrong credentials
        // Tap button to open dialog
        var button = accountbar.$.signin_button;
        button.fire('tap');
        var dialog = accountbar.$.signin_dialog;
        dialog.addEventListener('iron-overlay-opened', function dialog_opened_handler(event){
          dialog.removeEventListener(event.type, dialog_opened_handler);
          dialog.querySelector('[label=Username]').value = wrong_username;
          dialog.querySelector('[label=Password]').value = wrong_password;
          // Submit form
          dialog.querySelector('#signin_dialog_button').fire('tap');
          accountbar.addEventListener('authentication-failed', function authentication_failed(event){
            accountbar.removeEventListener(event.type, authentication_failed);
            flush(function(){
              if (!accountbar.$.signin_dialog.opened){
                // Wait for dialog to open
                accountbar.$.signin_dialog.addEventListener('iron-overlay-opened', function dialog_opened_handler2(event){
                  accountbar.$.signin_dialog.removeEventListener(event.type, dialog_opened_handler2);
                  // It should reopen the dialog
                  assert.equal(getComputedStyle(accountbar.$.signin_dialog).display, 'block');
                  //debugger;
                  // It should display an authentication error
                  assert.equal(accountbar.$.signin_dialog.querySelector('.error_message').textContent,
                    'Authentication failed.  Please sign in again.');
                  done();
                });
              }else{
                // It should reopen the dialog
                assert.equal(getComputedStyle(accountbar.$.signin_dialog).display, 'block');
                // TODO: Start here.  It does not yet reopen the dialog when I test it manually.
                //  Strangely, this test passes when run alone, but fails when it's run with all suites.
                //debugger;
                // It should display an authentication error
                assert.equal(accountbar.$.signin_dialog.querySelector('.error_message').textContent, 'Authentication failed.  Please sign in again.');
                done();
              }
            });
          });
        });
      });

    });

    suite('State: Sign up with existing credentials', function(){

      setup('Before each test, create test user account and sign out', function(done){
        accountbar = fixture('integration');
        hoodie = accountbar.hoodie;
        create_test_user_account(hoodie, function(){
          // Signout in case a user is signed in
          hoodie.account.signOut()
          .done(function(){
            done();
          });
        });
      });

      teardown('After each test, destroy test user account and delete localstorage record', function(done){
        accountbar = fixture('integration');
        hoodie = accountbar.hoodie;
        destroy_test_user_account(hoodie, flush, done);
      });

      test('test', function(){});
//       setup('Before each test, sign out, then sign in with wrong credentials', function(done){
//         accountbar = fixture('integration');
//         hoodie = accountbar.hoodie;
//         var wrong_username = 'test-wrong';
//         var wrong_password = 'pw-wrong';
//         // Signout in case a user is signed in
//         hoodie.account.signOut()
//         .done(hoodie.account.signIn(wrong_username, wrong_password))
//         // Wait for UI to update
//         .done(flush(done));
//       });

//       test('should display an authentication error and prompt you to sign in again', function() {
//         /*
//         Authentication error. Sign in again
//         */

//         assert.notEqual(accountbar.$.signin_dialog.querySelector('.error_message').textContent, '');
//       });
    

//       test('When you sign in, but authentication fails, the dialog should not close', function(done){
//         // TODO: Start here
//         assert.equal(getComputedStyle(accountbar.$.signin_dialog).display, 'block');
//         done();
//       });

    });

    </script>

  </body>
</html>
